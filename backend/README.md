# Vietnamese Image Captioning Backend

This is the backend server for the Vietnamese Image Captioning project.

## Authentication System

The authentication system uses JWT (JSON Web Tokens) for securing API endpoints. The system includes:

- User registration and login
- Token-based authentication
- Role-based access control (admin vs regular users)

### Recent Fixes (May 2025)

The following issues were fixed in the authentication system:

1. **Token Consistency**: Updated all token-related functions to use the same `SECRET_KEY` from settings.py instead of a hardcoded value
2. **Database Schema Alignment**: Updated the User model's schema to match the database initialization script (using SERIAL vs UUID)
3. **Case-insensitive Status Checking**: Fixed user status check to be case-insensitive ('active' vs 'Active')
4. **JSON Serialization**: Improved JSON serialization for user data, particularly for datetime fields
5. **Error Handling**: Enhanced error handling and logging throughout the authentication process

### API Endpoints

#### Authentication

- `POST /api/auth/login`: Authenticate a user and return a JWT token
- `POST /api/auth/register`: Register a new user
- `POST /api/logout`: Log out a user
- `GET /api/user`: Get the current user's information

#### User Management (Admin Only)

- `GET /api/admin/users`: Get all users
- `POST /api/admin/users`: Create a new user
- `GET /api/admin/users/:id`: Get a specific user
- `PUT /api/admin/users/:id`: Update a user
- `DELETE /api/admin/users/:id`: Delete a user

## Development

### Setup

1. Install dependencies:
   ```
   pip install -r requirements.txt
   ```

2. Configure the database:
   - PostgreSQL database is required
   - Update connection settings in `app/config/settings.py`

3. Run the server:
   ```
   python run.py
   ```

The server will start on http://localhost:5000 by default.

### Testing

Run unit tests:
```
python -m unittest discover tests
```

Test login functionality:
```
python test_login.py
```

### Database Schema

The system uses PostgreSQL with the following tables:

#### Users
- `id`: SERIAL PRIMARY KEY
- `username`: VARCHAR(100) UNIQUE NOT NULL
- `email`: VARCHAR(255) UNIQUE NOT NULL
- `password`: VARCHAR(255) NOT NULL (bcrypt hashed)
- `full_name`: VARCHAR(255)
- `biography`: TEXT
- `position`: VARCHAR(100)
- `country`: VARCHAR(100)
- `is_admin`: BOOLEAN DEFAULT FALSE
- `status`: VARCHAR(50) DEFAULT 'active'
- `created_at`: TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- `updated_at`: TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- `avatar`: VARCHAR(255) DEFAULT 'default.jpg'

## Database Structure Updates (2024)

The database has been enhanced to support admin functionality, user ratings, and analytics:

### Tables

1. **users**
   - `id`: Primary key
   - `username`: Unique username
   - `password`: Hashed password
   - `is_admin`: Boolean flag for admin privileges
   - `created_at`: Account creation timestamp

2. **images**
   - `id`: Primary key
   - `image_id`: Unique identifier for the image
   - `image_path`: Path to the stored image file
   - `user_caption`: Caption provided by users
   - `ai_caption`: Caption generated by the AI model
   - `user_id`: Foreign key to users table
   - `created_at`: Timestamp

3. **model_versions**
   - `id`: Primary key
   - `version_name`: Name/version of the model
   - `model_path`: Path to the model files
   - `is_active`: Whether this is the active model
   - `description`: Model description
   - `created_at`: Timestamp

4. **caption_ratings**
   - `id`: Primary key
   - `image_id`: Reference to the image
   - `user_id`: User who provided the rating (can be null for anonymous)
   - `rating`: Rating value (1-5)
   - `created_at`: When the rating was given

5. **user_activities**
   - `id`: Primary key
   - `activity_type`: Type of activity (visit, caption, contribution, rating)
   - `user_id`: User who performed the activity (can be null for anonymous)
   - `ip_address`: IP address of the user
   - `details`: JSON data with additional details
   - `created_at`: Timestamp

6. **contributions**
   - `id`: Primary key
   - `user_id`: User who contributed
   - `image_id`: Reference to the image
   - `status`: Status of contribution (pending, approved, rejected)
   - `reviewer_id`: Admin who reviewed the contribution
   - `review_notes`: Notes from the reviewer
   - `created_at`: When the contribution was made
   - `updated_at`: When the contribution was last updated

7. **daily_stats**
   - `id`: Primary key
   - `date`: Date of the statistics
   - `visits`: Number of visits that day
   - `caption_requests`: Number of caption requests
   - `contributions`: Number of user contributions
   - `ratings_count`: Number of ratings submitted
   - `ratings_sum`: Sum of all ratings (for calculating average)

## New Features

### Admin Features
- User management (CRUD operations for user accounts)
- Contribution review and management
- Statistics and analytics dashboard
- Model version management

### User Rating System
- Users can rate generated captions on a scale of 1-5
- Rating statistics are available per image
- Average rating and distribution are tracked

### Usage Statistics
- Daily visit tracking
- Caption generation tracking
- Contribution tracking
- Rating statistics

### Contribution Management
- Contribution workflow with approval process
- Admin review system
- Status tracking (pending, approved, rejected)

## API Endpoints

### Admin Endpoints
- `GET /api/admin/check` - Check admin status
- `GET /api/admin/users` - List all users (with pagination)
- `POST /api/admin/users` - Create a new user
- `PUT /api/admin/users/<id>` - Update user details
- `DELETE /api/admin/users/<id>` - Delete a user
- `GET /api/admin/contributions/pending` - Get pending contributions
- `PUT /api/admin/contributions/<id>` - Review a contribution

### Rating Endpoints
- `POST /api/rate/<image_id>` - Rate a caption
- `GET /api/ratings/<image_id>` - Get ratings for an image

### Statistics Endpoints
- `GET /api/stats` - Get usage statistics

### Contribution Endpoints
- `POST /api/contribute` - Submit a contribution
- `GET /api/contributions` - Get all contributions
- `GET /api/user/contributions` - Get user's contributions
- `PUT /api/contribution/<image_id>` - Update a contribution
- `DELETE /api/contribution/<image_id>` - Delete a contribution

## Running the Application

1. Install requirements:
   ```
   pip install -r requirements.txt
   ```

2. Set up your environment variables in a `.env` file.

3. Run the application:
   ```
   python run.py
   ```

## Database Initialization

The database structure is automatically initialized when the application starts. Make sure your PostgreSQL server is running and configured correctly in your environment variables. 